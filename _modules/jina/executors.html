

<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="X-UA-Compatible" content="IE=edge">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@JinaAI_">
<meta name="twitter:creator" content="@JinaAI_">
<meta name="description"
      content="Jina is the cloud-native neural search solution powered by the state-of-the-art AI and deep learning">
<meta property="og:title" content="Jina Documentation">
<meta property="og:description"
      content="Jina is the cloud-native neural search solution powered by the state-of-the-art AI and deep learning">
<meta property="og:url" content="https://opensource.jina.ai">
<meta property="og:image" content="../../_static/banner.png">
<meta property="og:type" content="website">
<link rel="icon" href="../../_static/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <title>jina.executors &mdash; Jina 0.4.1-devel documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/main.css" type="text/css" />

<!--  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">-->


  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/jina-prod-logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.4.1-devel
              </div>
            
          


          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Install</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/install/via-pip.html">Install Jina via <code class="docutils literal notranslate"><span class="pre">pip</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/install/via-docker.html">Install Jina via Docker Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/install/on-rasp-linux.html">Install Jina on Raspberry Pi and other Linux Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/install/upgrade.html">Upgrade Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/install/autocomplete.html">Autocomplete commands on Bash, Zsh and Fish</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/helloworld/index.html">Jina ‚ÄúHello, World!‚Äù üëãüåç</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/101/.sphinx.html">Jina 101: First Thing to Learn About Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/flow/index.html">Using Flow API to Compose Your Jina Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/io/index.html">Input and Output Functions in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/hub/index.html">Using Jina Pod with Docker Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/remote/index.html">Using Jina Pod Remotely</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/dashboard/index.html">Using Dashboard to Monitor Logs and View Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/cli/exit.html">Gracefully Exit Jina</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/cli/index.html">Jina Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/jina.html">Jina Python API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/yaml/yaml.html">Jina YAML Syntax Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/simple_exec.html">Built-in Simple Executors and Reserved <code class="docutils literal notranslate"><span class="pre">uses</span></code> in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/proto/index.html">Jina Protobuf Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/restapi/index.html">Jina REST API Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/envs.html">OS Environment Variables Used in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/api_schema.html">Jina API Schema for 3rd-Party Applications</a></li>
</ul>
<p class="caption"><span class="caption-text">Extending Jina</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/extend/mwu.html">A Minimum Working Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/extend/executor.html">Guideline When Adding New Executor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/extend/driver.html">Guideline When Adding New Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/hub/publish-your-pod-image.html">Publish Your Pod Image to Jina Hub</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/CONTRIBUTING.html">Contributing to Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/jep/index.html">Jina Enhancement Proposals (JEP)</a></li>
</ul>
<p class="caption"><span class="caption-text">Release Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/RELEASE.html">Release Cycle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/CHANGELOG.html">Change Logs</a></li>
</ul>
<p class="caption"><span class="caption-text">Debugging and FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/faq/user.html">FAQ for End-Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/faq/dev.html">FAQ for Developers</a></li>
</ul>
<p class="caption"><span class="caption-text">Indices and Tables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/all_exec.html">List of 112 Executors in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapters/all_driver.html">List of 46 Drivers in Jina</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Jina</a>
        
      </nav>

      <div class="card table-of-contents">
          <span class="card-title">Table of Contents</span>
            <div class="card-content">
            
            </div>
        <a href="https://github.com/jina-ai/jina/">
          <span class="toc-card-footer">
            <span>Visit us on Github</span>
          </span>
        </a>
      </div>

      <div id="showhide-navbar-btn" onclick="showhide_navbar()">
      </div>

      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation" class="nav-bar-header">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../jina.html">jina</a> &raquo;</li>
        
      <li>jina.executors</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  
<div role="search" class="nav-bar-search">
  <form id="rtd-search-form" class="wy-form doc-searchbox" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs (Press / to focus)" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

</div>
<hr/>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for jina.executors</h1><div class="highlight"><pre>
<span></span><span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (c) 2020 Jina AI Limited. All rights reserved.&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;Apache-2.0&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">SimpleNamespace</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">ruamel.yaml.constructor</span>
<span class="kn">from</span> <span class="nn">ruamel.yaml</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="kn">from</span> <span class="nn">.decorators</span> <span class="kn">import</span> <span class="n">as_train_method</span><span class="p">,</span> <span class="n">as_update_method</span><span class="p">,</span> <span class="n">store_init_kwargs</span>
<span class="kn">from</span> <span class="nn">.metas</span> <span class="kn">import</span> <span class="n">get_default_metas</span><span class="p">,</span> <span class="n">fill_metas_with_defaults</span>
<span class="kn">from</span> <span class="nn">..excepts</span> <span class="kn">import</span> <span class="n">EmptyExecutorYAML</span><span class="p">,</span> <span class="n">BadWorkspace</span><span class="p">,</span> <span class="n">BadPersistantFile</span><span class="p">,</span> <span class="n">NoDriverForRequest</span><span class="p">,</span> <span class="n">UnattachedDriver</span>
<span class="kn">from</span> <span class="nn">..helper</span> <span class="kn">import</span> <span class="n">yaml</span><span class="p">,</span> <span class="n">PathImporter</span><span class="p">,</span> <span class="n">expand_dict</span><span class="p">,</span> <span class="n">expand_env_var</span><span class="p">,</span> <span class="n">get_valid_local_config_source</span>
<span class="kn">from</span> <span class="nn">..logging.base</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">..logging.profile</span> <span class="kn">import</span> <span class="n">TimeContext</span>

<span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">..drivers</span> <span class="kn">import</span> <span class="n">BaseDriver</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BaseExecutor&#39;</span><span class="p">,</span> <span class="s1">&#39;AnyExecutor&#39;</span><span class="p">,</span> <span class="s1">&#39;ExecutorType&#39;</span><span class="p">]</span>

<span class="n">AnyExecutor</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;AnyExecutor&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s1">&#39;BaseExecutor&#39;</span><span class="p">)</span>

<span class="c1"># some variables may be self-referred and they must be resolved at here</span>
<span class="n">_ref_desolve_map</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
<span class="n">_ref_desolve_map</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;metas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
<span class="n">_ref_desolve_map</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;metas&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;replica_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">_ref_desolve_map</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;metas&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;separated_workspace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="ExecutorType"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.ExecutorType">[docs]</a><span class="k">class</span> <span class="nc">ExecutorType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">_cls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">register_class</span><span class="p">(</span><span class="n">_cls</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># do _preload_package</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;pre_init&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="kc">None</span><span class="p">)()</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;metas&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;metas&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;requests&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;requests&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># set attribute with priority</span>
        <span class="c1"># metas in YAML &gt; class attribute &gt; default_jina_config</span>
        <span class="c1"># jina_config = expand_dict(jina_config)</span>

        <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;_post_init_wrapper&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="kc">None</span><span class="p">)(</span><span class="n">m</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

<div class="viewcode-block" id="ExecutorType.register_class"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.ExecutorType.register_class">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">register_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">prof_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;encode&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;craft&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">]</span>
        <span class="n">update_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">]</span>
        <span class="n">train_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">wrap_func</span><span class="p">(</span><span class="n">func_lst</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">func_lst</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">f_name</span><span class="p">):</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">f_name</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">f_name</span><span class="p">)))</span>

        <span class="n">reg_cls_set</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;_registered_class&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reg_cls_set</span><span class="p">:</span>
            <span class="c1"># print(&#39;reg class: %s&#39; % cls.__name__)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span> <span class="o">=</span> <span class="n">store_init_kwargs</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
            <span class="c1"># if &#39;JINA_PROFILING&#39; in os.environ:</span>
            <span class="c1">#     wrap_func(prof_funcs, profiling)</span>

            <span class="n">wrap_func</span><span class="p">(</span><span class="n">train_funcs</span><span class="p">,</span> <span class="n">as_train_method</span><span class="p">)</span>
            <span class="n">wrap_func</span><span class="p">(</span><span class="n">update_funcs</span><span class="p">,</span> <span class="n">as_update_method</span><span class="p">)</span>

            <span class="n">reg_cls_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;_registered_class&#39;</span><span class="p">,</span> <span class="n">reg_cls_set</span><span class="p">)</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">register_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span></div></div>


<div class="viewcode-block" id="BaseExecutor"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor">[docs]</a><span class="k">class</span> <span class="nc">BaseExecutor</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ExecutorType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The base class of the executor, can be used to build encoder, indexer, etc.</span>

<span class="sd">    Any executor inherited from :class:`BaseExecutor` always has the **meta** defined in :mod:`jina.executors.metas.defaults`.</span>

<span class="sd">    All arguments in the :func:`__init__` can be specified with a ``with`` map in the YAML config. Example:</span>

<span class="sd">    .. highlight:: python</span>
<span class="sd">    .. code-block:: python</span>

<span class="sd">        class MyAwesomeExecutor:</span>
<span class="sd">            def __init__(awesomeness = 5):</span>
<span class="sd">                pass</span>

<span class="sd">    is equal to</span>

<span class="sd">    .. highlight:: yaml</span>
<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        !MyAwesomeExecutor</span>
<span class="sd">        with:</span>
<span class="sd">            awesomeness: 5</span>

<span class="sd">    To use an executor in a :class:`jina.peapods.pea.BasePea` or :class:`jina.peapods.pod.BasePod`,</span>
<span class="sd">    a proper :class:`jina.drivers.Driver` is required. This is because the</span>
<span class="sd">    executor is *NOT* protobuf-aware and has no access to the key-values in the protobuf message.</span>

<span class="sd">    Different executor may require different :class:`Driver` with</span>
<span class="sd">    proper :mod:`jina.drivers.handlers`, :mod:`jina.drivers.hooks` installed.</span>

<span class="sd">    .. seealso::</span>
<span class="sd">        Methods of the :class:`BaseExecutor` can be decorated via :mod:`jina.executors.decorators`.</span>

<span class="sd">    .. seealso::</span>
<span class="sd">        Meta fields :mod:`jina.executors.metas.defaults`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">store_args_kwargs</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#: set this to ``True`` to save ``args`` (in a list) and ``kwargs`` (in a map) in YAML config</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_post_init_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_snapshot_ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, List[&#39;BaseDriver&#39;]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attached_pea</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_check_on_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cuda_version</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;nvcc&#39;</span><span class="p">,</span> <span class="s1">&#39;--version&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CUDA compiler version: </span><span class="si">{</span><span class="n">cuda_version</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;on_gpu=True, but you dont have CUDA compatible GPU, i will reset on_gpu=False &#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_post_init_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_metas</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_requests</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fill_in_metas</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">TimeContext</span><span class="p">(</span><span class="s1">&#39;post initiating, this may take some time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fill_in_metas</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_metas</span><span class="p">:</span>
                    <span class="n">_metas</span> <span class="o">=</span> <span class="n">get_default_metas</span><span class="p">()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">_requests</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">..executors.requests</span> <span class="kn">import</span> <span class="n">get_default_reqs</span>
                    <span class="n">_requests</span> <span class="o">=</span> <span class="n">get_default_reqs</span><span class="p">(</span><span class="nb">type</span><span class="o">.</span><span class="n">mro</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_fill_metas</span><span class="p">(</span><span class="n">_metas</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fill_requests</span><span class="p">(</span><span class="n">_requests</span><span class="p">)</span>

            <span class="n">_before</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_on_gpu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_init</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_post_init_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_before</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_fill_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_requests</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">_requests</span> <span class="ow">and</span> <span class="s1">&#39;on&#39;</span> <span class="ow">in</span> <span class="n">_requests</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_requests</span><span class="p">[</span><span class="s1">&#39;on&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># if control request is forget in YAML, then fill it</span>
            <span class="k">if</span> <span class="s1">&#39;ControlRequest&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_requests</span><span class="p">[</span><span class="s1">&#39;on&#39;</span><span class="p">]:</span>
                <span class="kn">from</span> <span class="nn">..drivers.control</span> <span class="kn">import</span> <span class="n">ControlReqDriver</span>
                <span class="n">_requests</span><span class="p">[</span><span class="s1">&#39;on&#39;</span><span class="p">][</span><span class="s1">&#39;ControlRequest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ControlReqDriver</span><span class="p">()]</span>

            <span class="k">for</span> <span class="n">req_type</span><span class="p">,</span> <span class="n">drivers</span> <span class="ow">in</span> <span class="n">_requests</span><span class="p">[</span><span class="s1">&#39;on&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">req_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">req_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">req_type</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">req_type</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">!=</span> <span class="n">drivers</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">drivers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fill_metas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_metas</span><span class="p">):</span>
        <span class="n">unresolved_attr</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># set self values filtered by those non-exist, and non-expandable</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_metas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{.*?}&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\$.*\b&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)):</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">unresolved_attr</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">_id</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">warn_unnamed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;this executor is not named, i will call it &quot;</span><span class="si">%s</span><span class="s1">&quot;. &#39;</span>
                    <span class="s1">&#39;naming is important as it provides an unique identifier when &#39;</span>
                    <span class="s1">&#39;persisting this executor on disk.&#39;</span> <span class="o">%</span> <span class="n">_name</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unresolved_attr</span><span class="p">:</span>
            <span class="n">_tmp</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">_tmp</span><span class="p">[</span><span class="s1">&#39;metas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_metas</span>
            <span class="n">new_metas</span> <span class="o">=</span> <span class="n">expand_dict</span><span class="p">(</span><span class="n">_tmp</span><span class="p">)[</span><span class="s1">&#39;metas&#39;</span><span class="p">]</span>

            <span class="c1"># set self values filtered by those non-exist, and non-expandable</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_metas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{.*?}&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\$.*\b&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)):</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">expand_env_var</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">_ref_desolve_map</span><span class="p">,</span> <span class="n">this</span><span class="o">=</span><span class="n">_ref_desolve_map</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{.*?}&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\$.*\b&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)):</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> is not expandable or badly referred&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

<div class="viewcode-block" id="BaseExecutor.post_init"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor.post_init">[docs]</a>    <span class="k">def</span> <span class="nf">post_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize class attributes/members that can/should not be (de)serialized in standard way.</span>

<span class="sd">        Examples:</span>

<span class="sd">            - deep learning models</span>
<span class="sd">            - index files</span>
<span class="sd">            - numpy arrays</span>

<span class="sd">        .. warning::</span>
<span class="sd">            All class members created here will NOT be serialized when calling :func:`save`. Therefore if you</span>
<span class="sd">            want to store them, please override the :func:`__getstate__`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="BaseExecutor.pre_init"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor.pre_init">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">pre_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function is called before the object initiating (i.e. :func:`__call__`)</span>

<span class="sd">        Packages and environment variables can be set and load here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">save_abspath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the file path of the binary serialized object</span>

<span class="sd">        The file name ends with `.bin`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_file_from_workspace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.bin&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config_abspath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the file path of the YAML config</span>

<span class="sd">        The file name ends with `.yml`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_file_from_workspace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.yml&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_workspace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Get the path of the current workspace.</span>

<span class="sd">        :return: if ``separated_workspace`` is set to ``False`` then ``metas.workspace`` is returned,</span>
<span class="sd">                otherwise the ``metas.replica_workspace`` is returned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">work_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replica_workspace</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">separated_workspace</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span>  <span class="c1"># type: str</span>
        <span class="k">return</span> <span class="n">work_dir</span>

<div class="viewcode-block" id="BaseExecutor.get_file_from_workspace"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor.get_file_from_workspace">[docs]</a>    <span class="k">def</span> <span class="nf">get_file_from_workspace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a usable file path under the current workspace</span>

<span class="sd">        :param name: the name of the file</span>

<span class="sd">        :return depending on ``metas.separated_workspace`` the file could be located in ``metas.workspace`` or ``metas.replica_workspace``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_workspace</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_workspace</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;logger&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_init_vars</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_post_init_wrapper</span><span class="p">(</span><span class="n">fill_in_metas</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;ImportError is often caused by a missing component, &#39;</span>
                                <span class="s1">&#39;which often can be solved by &quot;pip install&quot; relevant package. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ex</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="BaseExecutor.train"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train this executor, need to be overrided</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="BaseExecutor.touch"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor.touch">[docs]</a>    <span class="k">def</span> <span class="nf">touch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Touch the executor and change ``is_updated`` to ``True`` so that one can call :func:`save`. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_updated</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BaseExecutor.save"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Persist data of this executor to the :attr:`workspace` (or :attr:`replica_workspace`). The data could be</span>
<span class="sd">        a file or collection of files produced/used during an executor run.</span>

<span class="sd">        These are some of the common data that you might want to persist:</span>

<span class="sd">            - binary dump/pickle of the executor</span>
<span class="sd">            - the indexed files</span>
<span class="sd">            - (pre)trained models</span>

<span class="sd">        .. warning::</span>
<span class="sd">            All class members created here will NOT be serialized when calling :func:`save`. Therefore if you</span>
<span class="sd">            want to store them, please implement the :func:`__getstate__`.</span>

<span class="sd">        It uses ``pickle`` for dumping. For members/attributes that are not valid or not efficient for ``pickle``, you</span>
<span class="sd">        need to implement their own persistence strategy in the :func:`__getstate__`.</span>

<span class="sd">        :param filename: file path of the serialized file, if not given then :attr:`save_abspath` is used</span>
<span class="sd">        :return: successfully persisted or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_updated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no update since </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_snapshot_ts</span><span class="si">:</span><span class="s1">%Y-%m-%d %H:%M:%S%z</span><span class="si">}</span><span class="s1">, will not save. &#39;</span>
                             <span class="s1">&#39;If you really want to save it, call &quot;touch()&quot; before &quot;save()&quot; to force saving&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_updated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">filename</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_abspath</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;JINA_EXECUTOR_WORKDIR&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_snapshot</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">bak_f</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="s1">&#39;.snapshot-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_snapshot_ts</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;NA&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">bak_f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bak_f</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_snapshot</span><span class="p">:</span>
                <span class="n">d_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshot_files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d_f</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">d_f</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_snapshot_ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;artifacts of this executor (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">) is persisted to </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BaseExecutor.save_config"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor.save_config">[docs]</a>    <span class="k">def</span> <span class="nf">save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Serialize the object to a yaml file</span>

<span class="sd">        :param filename: file path of the yaml file, if not given then :attr:`config_abspath` is used</span>
<span class="sd">        :return: successfully dumped or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_updated</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_updated</span><span class="p">,</span> <span class="kc">False</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">filename</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_abspath</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;JINA_EXECUTOR_WORKDIR&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">name</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;executor</span><span class="se">\&#39;</span><span class="s1">s yaml config is save to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_updated</span> <span class="o">=</span> <span class="n">_updated</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BaseExecutor.load_config"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor.load_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">AnyExecutor</span><span class="p">],</span> <span class="n">source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TextIO</span><span class="p">],</span> <span class="n">separated_workspace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">replica_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AnyExecutor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Build an executor from a YAML file.</span>

<span class="sd">        :param filename: the file path of the YAML file or a ``TextIO`` stream to be loaded from</span>
<span class="sd">        :param separated_workspace: the dump and data files associated to this executor will be stored separately for</span>
<span class="sd">                each replica, which will be indexed by the ``replica_id``</span>
<span class="sd">        :param replica_id: the id of the storage of this replica, only effective when ``separated_workspace=True``</span>
<span class="sd">        :return: an executor object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">FileNotFoundError</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">get_valid_local_config_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="c1"># first scan, find if external modules are specified</span>
        <span class="k">with</span> <span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">source</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="c1"># ignore all lines start with ! because they could trigger the deserialization of that class</span>
            <span class="n">safe_yml</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[\s-]*?!\b&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="s1">&#39;__tag: &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">safe_yml</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tmp</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;metas&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;metas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">fill_metas_with_defaults</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;py_modules&#39;</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;metas&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;metas&#39;</span><span class="p">][</span><span class="s1">&#39;py_modules&#39;</span><span class="p">]:</span>
                    <span class="n">mod</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;metas&#39;</span><span class="p">][</span><span class="s1">&#39;py_modules&#39;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">mod</span> <span class="o">=</span> <span class="p">[</span><span class="n">mod</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">mod</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mod</span><span class="p">]</span>
                        <span class="n">PathImporter</span><span class="o">.</span><span class="n">add_modules</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span><span class="si">!r}</span><span class="s1"> is not acceptable, only str or list are acceptable&#39;</span><span class="p">)</span>

                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;metas&#39;</span><span class="p">][</span><span class="s1">&#39;separated_workspace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">separated_workspace</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;metas&#39;</span><span class="p">][</span><span class="s1">&#39;replica_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replica_id</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EmptyExecutorYAML</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1"> is empty? nothing to read from there&#39;</span><span class="p">)</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">expand_dict</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
            <span class="n">tmp_s</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__tag: &#39;</span><span class="p">,</span> <span class="s1">&#39;!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tmp_s</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseExecutor.load"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor.load">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AnyExecutor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Build an executor from a binary file</span>

<span class="sd">        :param filename: the file path of the binary serialized file</span>
<span class="sd">        :return: an executor object</span>

<span class="sd">        It uses ``pickle`` for loading.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">FileNotFoundError</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadPersistantFile</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;broken file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1"> can not be loaded&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseExecutor.close"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Release the resources as executor is destroyed, need to be overrided</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="BaseExecutor.to_yaml"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor.to_yaml">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">to_yaml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">representer</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Required by :mod:`ruamel.yaml.constructor` &quot;&quot;&quot;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">_dump_instance_to_yaml</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;_drivers&#39;</span><span class="p">):</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;on&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">_drivers</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">representer</span><span class="o">.</span><span class="n">represent_mapping</span><span class="p">(</span><span class="s1">&#39;!&#39;</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseExecutor.from_yaml"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor.from_yaml">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_yaml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">constructor</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Required by :mod:`ruamel.yaml.constructor` &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_instance_from_yaml</span><span class="p">(</span><span class="n">constructor</span><span class="p">,</span> <span class="n">node</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_instance_from_yaml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">constructor</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ruamel</span><span class="o">.</span><span class="n">yaml</span><span class="o">.</span><span class="n">constructor</span><span class="o">.</span><span class="n">SafeConstructor</span><span class="o">.</span><span class="n">construct_mapping</span><span class="p">(</span>
            <span class="n">constructor</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">_meta_config</span> <span class="o">=</span> <span class="n">get_default_metas</span><span class="p">()</span>
        <span class="n">_meta_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metas&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">if</span> <span class="n">_meta_config</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;metas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_meta_config</span>

        <span class="n">dump_path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_dump_path_from_config</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metas&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">load_from_dump</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">dump_path</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dump_path</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;restore </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> from </span><span class="si">{</span><span class="n">dump_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">load_from_dump</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">init_from_yaml</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">store_args_kwargs</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;with&#39;</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># type: Dict[str, Any]</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;args&#39;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="p">()</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;kwargs&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;kwargs&#39;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="p">{}</span>
                <span class="c1"># maybe there are some hanging kwargs in &quot;parameters&quot;</span>
                <span class="c1"># tmp_a = (expand_env_var(v) for v in a)</span>
                <span class="c1"># tmp_p = {kk: expand_env_var(vv) for kk, vv in {**k, **p}.items()}</span>
                <span class="n">tmp_a</span> <span class="o">=</span> <span class="n">a</span>
                <span class="n">tmp_p</span> <span class="o">=</span> <span class="p">{</span><span class="n">kk</span><span class="p">:</span> <span class="n">vv</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="p">{</span><span class="o">**</span><span class="n">k</span><span class="p">,</span> <span class="o">**</span><span class="n">p</span><span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">tmp_a</span><span class="p">,</span> <span class="o">**</span><span class="n">tmp_p</span><span class="p">,</span> <span class="n">metas</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metas&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">requests</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;requests&#39;</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># tmp_p = {kk: expand_env_var(vv) for kk, vv in data.get(&#39;with&#39;, {}).items()}</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;with&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">metas</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metas&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">requests</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;requests&#39;</span><span class="p">,</span> <span class="p">{}))</span>

            <span class="n">obj</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;successfully built </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> from a yaml config&#39;</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">init_from_yaml</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># if node.tag in {&#39;!CompoundExecutor&#39;}:</span>
        <span class="c1">#     os.environ[&#39;JINA_WARN_UNNAMED&#39;] = &#39;YES&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">_meta_config</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;&quot;metas&quot; config is not found in this yaml file, &#39;</span>
                <span class="s1">&#39;this map is important as it provides an unique identifier when &#39;</span>
                <span class="s1">&#39;persisting the executor on disk.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">obj</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">load_from_dump</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_dump_path_from_config</span><span class="p">(</span><span class="n">meta_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">meta_config</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">meta_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;separated_workspace&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;replica_id&#39;</span> <span class="ow">in</span> <span class="n">meta_config</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meta_config</span><span class="p">[</span><span class="s1">&#39;replica_id&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">work_dir</span> <span class="o">=</span> <span class="n">meta_config</span><span class="p">[</span><span class="s1">&#39;replica_workspace&#39;</span><span class="p">]</span>
                    <span class="n">dump_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">meta_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="s2">&quot;bin&quot;</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dump_path</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">dump_path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadWorkspace</span><span class="p">(</span><span class="s1">&#39;separated_workspace=True but replica_id is unset or set to a bad value&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dump_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workspace&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()),</span>
                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">meta_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="s2">&quot;bin&quot;</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dump_path</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">dump_path</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_dump_instance_to_yaml</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="c1"># note: we only save non-default property for the sake of clarity</span>
        <span class="n">_defaults</span> <span class="o">=</span> <span class="n">get_default_metas</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_defaults</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="n">v</span><span class="p">}</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">_init_kwargs_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_defaults</span><span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">a</span><span class="p">:</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;with&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;metas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">return</span> <span class="n">r</span>

<div class="viewcode-block" id="BaseExecutor.add_driver"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor.add_driver">[docs]</a>    <span class="k">def</span> <span class="nf">add_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">:</span> <span class="s1">&#39;BaseDriver&#39;</span><span class="p">,</span> <span class="n">req_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a driver to this executor.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This has to be used *before* ``.attach(pea=self)`` to be effective</span>

<span class="sd">        :param driver: the driver to add</span>
<span class="sd">        :param req_type: the request type to handle by this driver</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">driver</span> <span class="o">=</span> <span class="p">[</span><span class="n">driver</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">req_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">req_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">req_type</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseExecutor.attach"><a class="viewcode-back" href="../../api/jina.executors.html#jina.executors.BaseExecutor.attach">[docs]</a>    <span class="k">def</span> <span class="nf">attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attach this executor to a :class:`jina.peapods.pea.BasePea`.</span>

<span class="sd">        This is called inside the initializing of a :class:`jina.peapods.pea.BasePea`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">executor</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_type</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">req_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">req_type</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">attached</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">UnattachedDriver</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoDriverForRequest</span><span class="p">(</span><span class="n">req_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Jina AI Limited. All rights reserved.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });

      function showhide_navbar() {
      var x = document.getElementsByClassName("wy-nav-side")[0];
      var y = document.getElementsByClassName("wy-nav-content-wrap")[0];
      var z = document.getElementById("showhide-navbar-btn");
      if (x.style.display === "none") {
        x.style.display = "block";
        y.style.marginLeft = "23rem";
        z.style.left = "23rem";
      } else {
        x.style.display = "none";
        y.style.marginLeft = "0";
        z.style.left = "0px";
      }
    }
  </script>

  <!-- Search box becomes active when you press the slash(/) key anywhere on the page-->
  <script>
    const body = document.querySelector('body');
    const searchBox = document.querySelector('form').querySelector('input[type="text"]');

    body.addEventListener('keyup', event => {
      event.preventDefault()
      if (event.key === '/') {
        searchBox.focus();
      }
    });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-164627626-3', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>